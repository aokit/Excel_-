新しいモジュールを追加することができるが、
シートができるタイミングが遅くなるのか、Module1からのコピーができないという状況。

シートで使う関数の関数定義 ( Function ... End Function ) は、 標準モジュールに設置すること。
そうしていないと、シートで参照したときに NAME# エラーが生じる。

組織名変換のためのサブルーチンを作ることにした。
＝＝＝＝＝＝＝＝
belong2whom(組織定義の領域,参照領域,所属領域）
＝＝＝＝
参照領域にある文字列を、組織定義の領域で検索し、帰属領域に結果を書き込む。

《組織定義の領域》
下位組織名Bが帰属する上位組織名A（さらには、上位組織名Aが保有する下位組織名B）
を以下の正規表現で列に配置した領域。上位組織名Aと同じ組織名を下位組織名Bとして
有する場合があるが明記しない。また、下位組織名Bの無い上位組織名Aもありうる。
(A(B*))+
上位組織Aと下位組織Bはセルの背景色によって識別される。
領域の第１行の背景色によって、上位組織が定義される。

《参照領域》
帰属する上位組織名Aを得たい下位組織名Bを列に配置したもの

《帰属領域》
帰属することがわかった上位組織名Aを書き込む領域

なお、参照領域と所属領域は同じ行数の１列領域であること。
＝＝＝＝＝＝＝＝

＝＝＝＝
ひとまずは、Excelシートの整理をして、255件に対応できるようにはした。
組織の計数ための親組織の処理に、セルの背景色の判別をFunctionで行っている。
このスクリプトはシートに置くことができない。
しかし、１年間の取引（６００件程度）を取り扱うときに同じ取扱ができないかもしれず、
仕向地の扱いも付け焼き刃であり、判断根拠も残りにくい。
以下の処理を VBA で書いてみようと考える。
＝＝＝＝

■例外の有無と例外がある場合その取り扱いについて多少の違いのある３通りの頻度計数処理を行う

１：BU名の親組織計数
・BU名を親組織に組み入れて計数する。
・以下の例外が起きる
旧組織等（親組織が記載されていないBU）を現行の親組織に組み入れる
・すべて例外もふくめ、かならずどれか１つの親組織として計数する。

２：取引区分の計数
・例外はなく、あらかじめ設定した取引内容種別のいずれか１つの取引区分として計数する。

３：仕向地の計数
・以下の例外が起きる
A:いずれか１つの仕向地となるが表記が異なるもの
B:複数の仕向地として表記されているもの
・Aの例外は、割り当てた１つの仕向地として計数する。
・Bの例外は、割り当てた複数の仕向地についてそれぞれ１つとして計数する。
　（頻度の総和が増えることになる）
・すべての例外も含め、かならずどれか１つもしくは複数の仕向地として計数する。

■仕向地については例外のある金額集計を得る

・以下の例外が起きる
A:いずれか１つの仕向地となるが表記が異なるもの
B:複数の仕向地として表記されているもの
・Aの例外は、割り当てた１つの仕向地として金額集計する。
・Bの例外は、割り当てた複数の仕向地に等分とみなして金額集計する。
　（金額集計の総和は増えない）
・すべての例外も含め、金額のどの部分もどれかの仕向地の金額集計に組み入れられる。

＝＝＝＝
１と３Aおよび３Bのために、例外の検出・例外に対する処理の指定・結果の確認の処理
ループが必要になる。

＝＝＝＝
入力１：集計の期間等の設定（組織の略称シート、仕向地の割当シート）
出力１：組織計数・・・・・ついでに組織金額集計
出力２（入力２）：組織の例外（とその取扱指定）
出力３：取引区分計数・・・ついでに取引区分金額集計
出力４：仕向地計数・・・・ついでに仕向地金額集計
出力５（入力３）：仕向地の例外（とその取扱指定）
実行ボタン
＝＝＝＝
こんな感じか。

これらを、コンソール／ダッシュボードに作ればよさそう。

仕向地の割当シートは、国名に対して別名を定義するが、同じ別名が複数の国名にあたる場合も許すものとする。その場合、同じ別名が何回適用されているかが、わかるといいと思われる。

複数のシートの複数の範囲（領域）を指定して処理するのであるが、それらの範囲（領域-Range-）
について、いずれも名前を与えて使うことにする。
名前の割当によって、
・範囲の指定に欠損がないことを確認し、また、
・必要に応じて範囲を切り替えたり動的に変更したり、
・シート名の変更などに対して影響受けにくいようにできる。
入出力が多い処理や、（この処理もそうだが）人手の作業がループに入らないと完成しない作業では
このようにして入出力を指定するのはよい方法かもしれない。
もともと表計算ベースなので、可視性と一覧性、網羅性の確認のしやすさ等、
エクセルを使った場合には、こうした実装が（他の処理系にくらべて）やりやすいかもしれない。

シート◆ダッシュボード
＝入力領域＝
・名前『集計期間』（開始期日と終了期日）を与えた領域-Range-
・名前『取引区分』を与えた領域-Range-
・名前『組織集計』（年間登録と個別審査の組織別件数）を与えた領域-Range-
＝出力領域＝
・名前『』
・名前『包括許可適用』承認番号のカラム：包括許可適用を書き出す領域-Range-
・名前『少額特例適用』承認番号のカラム：少額特例適用を書き出す領域-Range-
・名前『公知特例適用』承認番号のカラム：公知特例適用を書き出す領域-Range-
・名前『該当国内取引』承認番号のカラム：該当国内取引を書き出す領域-Range-
＝入力出力領域の設定状態と処理概要の表示＝
・名前『集計期間』の定義／未定義表示
・名前『組織』の定義／未定義表示
・名前『承認記録』の定義／未定義表示
・名前『取引区分』の定義／未定義表示
・名前『組織集計』の定義／未定義表示
・組織名と仕向地名の例外解決／未解決表示
・期間中の審査件数の表示
・承認番号関係４カラム　の　件数表示

シート◆仕向地
シート◆組織略称
シート＋（名前『組織』をあたえた領域をもつ公式の組織シート）
シート＋（名前『承認記録』をあたえた領域をもつ審査の承認記録のシート）

▼集計名《組織》初期化：シート◆組織略称をもとに、名前『年間登録』の領域を初期化する。
・名前『年間登録』も設定する：集計名と件数
・名前『個別審査』も設定する
※　ここで、Range から配列に読み込みができない。なんでかな。
https://riptutorial.com/ja/excel-vba/example/26794/%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E7%AF%84%E5%9B%B2%E9%85%8D%E5%88%97
これで、いいみたい。具体的には
For Each c In ThisWorkbook.Names("組織").RefersToRange
ができた。
組織略称 = ThisWorkbook.Names("組織").RefersToRange
もできた。

◆ダッシュボード　のシートで『集計』ボタンをクリックすると
◆仕向地　のシート　の　別名　のカラムに例外となった名前が入る。また、
◆組織略称　のシート　の　別名　のカラムに例外となった名前が入る。
いずれかのシートで、例外となった名前が発生したときには、
例外未解決　の表示をおこなう。

◆仕向地　のシートで集計名のカラムのセルの選択（複数の場合には複数セルの選択）
とともに別名のカラムのセルの選択をして『割当』のボタンをクリックすると
◆仕向地　のシートの　別名→　のカラムより右側の空いているセルにそれぞれ選択した別名が
書き込まれる。さらに、
書き込まれた結果として、シートの中に現れるその別名の回数が　回数　のカラムに書き込まれる。
（回数がすべて１以上になるのが完了）

◆組織略称　のシートで『読み込み』ボタンをクリックすると
◆ダッシュボード　のシートで変数　組織　として定義されたシート＆領域　から
　集計名のカラム（に親組織名）　と
　別名→　以降のカラム　に
その親組織名に属するBU等組織名を読み込む。

◆組織略称　のシートで集計名のカラムのセルの選択（組織名では単一の選択以外はエラー報告）
とともに別名のカラムのセルの選択（複数の場合には複数セルの選択）をして
『割当』のボタンをクリックすると
◆組織略称　のシートの　別名→　のカラムより右側の空いているセルにそれぞれ選択した別名が
書き込まれる。さらに、
書き込まれた結果として、シートの中に現れるその別名の回数が　回数　のカラムに書き込まれる。
（回数がすべて１になるのが完了）
書き込みの回数が２以上になるときんはエラー報告



